/*
UploadiFive 1.2.3
Copyright (c) 2012 Reactive Apps, Ronnie Garcia
Released under the UploadiFive Standard License <http://www.uploadify.com/uploadifive-standard-license>
*/
!function(d){var u={init:function(i){return this.each(function(){var a=d(this);a.data("uploadifive",{inputs:{},inputCount:0,fileID:0,queue:{count:0,selected:0,replaced:0,errors:0,queued:0,cancelled:0},uploads:{current:0,attempts:0,successful:0,errors:0,count:0}});var r,e,t,s=a.data("uploadifive"),p=s.settings=d.extend({auto:!0,buttonClass:!1,buttonText:"Select Files",checkScript:!1,dnd:!0,dropTarget:!1,fileObjName:"Filedata",fileSizeLimit:0,fileType:!1,formData:{},height:30,itemTemplate:!1,method:"post",multi:!0,overrideEvents:[],queueID:!1,queueSizeLimit:0,removeCompleted:!1,simUploadLimit:0,truncateLength:0,uploadLimit:0,uploadScript:"uploadifive.php",width:100},i);if(p.fileType&&(r=p.fileType.split("|")),isNaN(p.fileSizeLimit)?(e=1.024*parseInt(p.fileSizeLimit),-1<p.fileSizeLimit.indexOf("KB")?p.fileSizeLimit=1e3*e:-1<p.fileSizeLimit.indexOf("MB")?p.fileSizeLimit=1e6*e:-1<p.fileSizeLimit.indexOf("GB")&&(p.fileSizeLimit=1e9*e)):p.fileSizeLimit=1024*p.fileSizeLimit,s.inputTemplate=d('<input type="file">').css({"font-size":p.height+"px",opacity:0,position:"absolute",right:"-3px",top:"-3px","z-index":999}),s.createInput=function(){var e=s.inputTemplate.clone(),i=e.name="input"+s.inputCount++;p.multi&&e.attr("multiple",!0),p.fileType&&e.attr("accept",p.fileType),e.bind("change",function(){s.queue.selected=0,s.queue.replaced=0,s.queue.errors=0,s.queue.queued=0;var e=this.files.length;if(s.queue.selected=e,s.queue.count+e>p.queueSizeLimit&&0!==p.queueSizeLimit)d.inArray("onError",p.overrideEvents)<0&&alert("The maximum number of queue items has been reached ("+p.queueSizeLimit+").  Please select fewer files."),"function"==typeof p.onError&&p.onError.call(a,"QUEUE_LIMIT_EXCEEDED");else{for(var t=0;t<e;t++)file=this.files[t],s.addQueueItem(file);s.inputs[i]=this,s.createInput()}p.auto&&u.upload.call(a),"function"==typeof p.onSelect&&p.onSelect.call(a,s.queue)}),s.currentInput&&s.currentInput.hide(),s.button.append(e),s.currentInput=e},s.destroyInput=function(e){d(s.inputs[e]).remove(),delete s.inputs[e],s.inputCount--},s.drop=function(e){e.preventDefault(),e.stopPropagation(),s.queue.selected=0,s.queue.replaced=0,s.queue.errors=0,s.queue.queued=0;var t=e.dataTransfer,i=t.name="input"+s.inputCount++,n=t.files.length;if(s.queue.selected=n,s.queue.count+n>p.queueSizeLimit&&0!==p.queueSizeLimit)d.inArray("onError",p.overrideEvents)<0&&alert("The maximum number of queue items has been reached ("+p.queueSizeLimit+").  Please select fewer files."),"function"==typeof p.onError&&p.onError.call(a,"QUEUE_LIMIT_EXCEEDED");else{for(var o=0;o<n;o++)file=t.files[o],s.addQueueItem(file),r&&-1===r.indexOf(file.type)&&s.error("FORBIDDEN_FILE_TYPE",file);s.inputs[i]=t}p.auto&&u.upload.call(a),"function"==typeof p.onDrop&&p.onDrop.call(a,t.files,t.files.length)},s.fileExistsInQueue=function(e){for(var t in s.inputs){input=s.inputs[t],limit=input.files.length;for(var i=0;i<limit;i++)if(existingFile=input.files[i],existingFile.name==e.name&&!existingFile.complete)return!0}return!1},!(s.removeExistingFile=function(e){for(var t in s.inputs){input=s.inputs[t],limit=input.files.length;for(var i=0;i<limit;i++)existingFile=input.files[i],existingFile.name!=e.name||existingFile.complete||(s.queue.replaced++,u.cancel.call(a,existingFile,!0))}})===p.itemTemplate?s.queueItem=d('<div class="uploadifive-queue-item"><a class="close" href="#">X</a><div><span class="filename"></span><span class="fileinfo"></span></div><div class="progress"><div class="progress-bar"></div></div></div>'):s.queueItem=d(p.itemTemplate),s.addQueueItem=function(e){var t;d.inArray("onAddQueueItem",p.overrideEvents)<0&&(s.removeExistingFile(e),e.queueItem=s.queueItem.clone(),e.queueItem.attr("id",p.id+"-file-"+s.fileID++),e.queueItem.find(".close").bind("click",function(){return u.cancel.call(a,e),!1}),(t=e.name).length>p.truncateLength&&0!==p.truncateLength&&(t=t.substring(0,p.truncateLength)+"..."),e.queueItem.find(".filename").html(t),e.queueItem.data("file",e),s.queueEl.append(e.queueItem)),"function"==typeof p.onAddQueueItem&&p.onAddQueueItem.call(a,e),e.size>p.fileSizeLimit&&0!==p.fileSizeLimit&&s.error("FILE_SIZE_LIMIT_EXCEEDED",e),s.queue.queued++,s.queue.count++},s.removeQueueItem=function(e,t,i){i=i||0;var n=t?0:500;e.queueItem&&(" - Completed"!=e.queueItem.find(".fileinfo").html()&&e.queueItem.find(".fileinfo").html(" - Cancelled"),e.queueItem.find(".progress-bar").width(0),e.queueItem.delay(i).fadeOut(n,function(){d(this).remove()}),delete e.queueItem,s.queue.count--)},s.filesToUpload=function(){var e=0;for(var t in s.inputs){input=s.inputs[t],limit=input.files.length;for(var i=0;i<limit;i++)file=input.files[i],file.skip||file.complete||e++}return e},s.checkExists=function(t){if(d.inArray("onCheck",p.overrideEvents)<0){d.ajaxSetup({async:!1});var e=d.extend(p.formData,{filename:t.name});if(d.post(p.checkScript,e,function(e){t.exists=parseInt(e)}),t.exists&&!confirm("A file named "+t.name+" already exists in the upload folder.\nWould you like to replace it?"))return u.cancel.call(a,t),!0}return"function"==typeof p.onCheck&&p.onCheck.call(a,t,t.exists),!1},s.uploadFile=function(u,l){if(!u.skip&&!u.complete&&!u.uploading)if(u.uploading=!0,s.uploads.current++,s.uploads.attempted++,xhr=u.xhr=new XMLHttpRequest,"function"==typeof FormData||"object"==typeof FormData){var e=new FormData;for(var t in e.append(p.fileObjName,u),p.formData)e.append(t,p.formData[t]);xhr.open(p.method,p.uploadScript,!0),xhr.upload.addEventListener("progress",function(e){e.lengthComputable&&s.progress(e,u)},!1),xhr.addEventListener("load",function(e){4==this.readyState&&(u.uploading=!1,200==this.status?"Invalid file type."!==u.xhr.responseText?s.uploadComplete(e,u,l):s.error(u.xhr.responseText,u,l):404==this.status?s.error("404_FILE_NOT_FOUND",u,l):403==this.status?s.error("403_FORBIDDEN",u,l):s.error("Unknown Error",u,l))}),xhr.send(e)}else{var i=new FileReader;i.onload=function(e){var t="-------------------------"+(new Date).getTime(),i="--",n="\r\n",o="";for(var r in o+=i+t+n,o+='Content-Disposition: form-data; name="'+p.fileObjName+'"',u.name&&(o+='; filename="'+u.name+'"'),o+=n,o+="Content-Type: application/octet-stream"+n+n,o+=e.target.result+n,p.formData)o+=i+t+n,o+='Content-Disposition: form-data; name="'+r+'"'+n+n,o+=p.formData[r]+n;o+=i+t+i+n,xhr.upload.addEventListener("progress",function(e){s.progress(e,u)},!1),xhr.addEventListener("load",function(e){u.uploading=!1,404==this.status?s.error("404_FILE_NOT_FOUND",u,l):"Invalid file type."!=u.xhr.responseText?s.uploadComplete(e,u,l):s.error(u.xhr.responseText,u,l)},!1);p.uploadScript;"get"==p.method&&d(p.formData).param(),xhr.open(p.method,p.uploadScript,!0),xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+t),"function"==typeof p.onUploadFile&&p.onUploadFile.call(a,u),xhr.sendAsBinary(o)},i.readAsBinaryString(u)}},s.progress=function(e,t){var i;d.inArray("onProgress",p.overrideEvents)<0&&(e.lengthComputable&&(i=Math.round(e.loaded/e.total*100)),t.queueItem.find(".fileinfo").html(" - "+i+"%"),t.queueItem.find(".progress-bar").css("width",i+"%")),"function"==typeof p.onProgress&&p.onProgress.call(a,t,e)},s.error=function(e,t,i){if(d.inArray("onError",p.overrideEvents)<0){switch(e){case"404_FILE_NOT_FOUND":errorMsg="404 Error";break;case"403_FORBIDDEN":errorMsg="403 Forbidden";break;case"FORBIDDEN_FILE_TYPE":errorMsg="Forbidden File Type";break;case"FILE_SIZE_LIMIT_EXCEEDED":errorMsg="File Too Large";break;default:errorMsg="Unknown Error"}t.queueItem.addClass("error").find(".fileinfo").html(" - "+errorMsg),t.queueItem.find(".progress").remove()}"function"==typeof p.onError&&p.onError.call(a,e,t),t.skip=!0,"404_FILE_NOT_FOUND"==e?s.uploads.errors++:s.queue.errors++,i&&u.upload.call(a,null,!0)},s.uploadComplete=function(e,t,i){d.inArray("onUploadComplete",p.overrideEvents)<0&&(t.queueItem.find(".progress-bar").css("width","100%"),t.queueItem.find(".fileinfo").html(" - Completed"),t.queueItem.find(".progress").slideUp(250),t.queueItem.addClass("complete")),"function"==typeof p.onUploadComplete&&p.onUploadComplete.call(a,t,t.xhr.responseText),p.removeCompleted&&setTimeout(function(){u.cancel.call(a,t)},3e3),t.complete=!0,s.uploads.successful++,s.uploads.count++,s.uploads.current--,delete t.xhr,i&&u.upload.call(a,null,!0)},s.queueComplete=function(){"function"==typeof p.onQueueComplete&&p.onQueueComplete.call(a,s.uploads)},!(window.File&&window.FileList&&window.Blob&&(window.FileReader||window.FormData)))return"function"==typeof p.onFallback&&p.onFallback.call(a),!1;p.id="uploadifive-"+a.attr("id"),s.button=d('<div id="'+p.id+'" class="uploadifive-button">'+p.buttonText+"</div>"),p.buttonClass&&s.button.addClass(p.buttonClass),s.button.css({height:p.height,"line-height":p.height+"px",overflow:"hidden",position:"relative","text-align":"center",width:p.width}),a.before(s.button).appendTo(s.button).hide(),s.createInput.call(a),p.queueID?s.queueEl=d("#"+p.queueID):(p.queueID=p.id+"-queue",s.queueEl=d('<div id="'+p.queueID+'" class="uploadifive-queue" />'),s.button.after(s.queueEl)),p.dnd&&((t=p.dropTarget?d(p.dropTarget):s.queueEl.get(0)).addEventListener("dragleave",function(e){e.preventDefault(),e.stopPropagation()},!1),t.addEventListener("dragenter",function(e){e.preventDefault(),e.stopPropagation()},!1),t.addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()},!1),t.addEventListener("drop",s.drop,!1)),XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(e){var t=Array.prototype.map.call(e,function(e){return 255&e.charCodeAt(0)}),i=new Uint8Array(t);this.send(i.buffer)}),"function"==typeof p.onInit&&p.onInit.call(a)})},debug:function(){return this.each(function(){console.log(d(this).data("uploadifive"))})},clearQueue:function(){this.each(function(){var e=d(this),t=e.data("uploadifive"),n=t.settings;for(var o in t.inputs)for(input=t.inputs[o],limit=input.files.length,i=0;i<limit;i++)file=input.files[i],u.cancel.call(e,file);"function"==typeof n.onClearQueue&&n.onClearQueue.call(e,d("#"+t.settings.queueID))})},cancel:function(n,o){this.each(function(){var e=d(this),t=e.data("uploadifive"),i=t.settings;"string"==typeof n&&(isNaN(n)||(fileID="uploadifive-"+d(this).attr("id")+"-file-"+n),n=d("#"+fileID).data("file")),n.skip=!0,t.filesCancelled++,n.uploading&&(t.uploads.current--,n.uploading=!1,n.xhr.abort(),delete n.xhr,u.upload.call(e)),d.inArray("onCancel",i.overrideEvents)<0&&t.removeQueueItem(n,o),"function"==typeof i.onCancel&&i.onCancel.call(e,n)})},upload:function(o,r){this.each(function(){var e,t=d(this),i=t.data("uploadifive"),n=i.settings;o?i.uploadFile.call(t,o):i.uploads.count+i.uploads.current<n.uploadLimit||0===n.uploadLimit?(r||(i.uploads.attempted=0,i.uploads.successsful=0,i.uploads.errors=0,e=i.filesToUpload(),"function"==typeof n.onUpload&&n.onUpload.call(t,e)),d("#"+n.queueID).find(".uploadifive-queue-item").not(".error, .complete").each(function(){return _file=d(this).data("file"),!(i.uploads.current>=n.simUploadLimit&&0!==n.simUploadLimit||i.uploads.current>=n.uploadLimit&&0!==n.uploadLimit||i.uploads.count>=n.uploadLimit&&0!==n.uploadLimit)&&void(n.checkScript?(_file.checking=!0,skipFile=i.checkExists(_file),_file.checking=!1,skipFile||i.uploadFile(_file,!0)):i.uploadFile(_file,!0))}),0===d("#"+n.queueID).find(".uploadifive-queue-item").not(".error, .complete").length&&i.queueComplete()):0===i.uploads.current&&(d.inArray("onError",n.overrideEvents)<0&&0<i.filesToUpload()&&0!==n.uploadLimit&&alert("The maximum upload limit has been reached."),"function"==typeof n.onError&&n.onError.call(t,"UPLOAD_LIMIT_EXCEEDED",i.filesToUpload()))})},destroy:function(){this.each(function(){var e=d(this),t=e.data("uploadifive"),i=t.settings;u.clearQueue.call(e),i.queueID||d("#"+i.queueID).remove(),e.siblings("input").remove(),e.show().insertBefore(t.button),t.button.remove(),"function"==typeof i.onDestroy&&i.onDestroy.call(e)})}};d.fn.uploadifive=function(e){return u[e]?u[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void d.error("The method "+e+" does not exist in $.uploadify"):u.init.apply(this,arguments)}}(jQuery);